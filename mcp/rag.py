"""RAG (Retrieval Augmented Generation) модуль для HR-документов."""

import re
from pathlib import Path

# Документы HR-политики для индексации
HR_DOCUMENTS = [
    {
        "id": "doc_1",
        "text": "Политика отпусков: Каждому сотруднику предоставляется 28 календарных дней оплачиваемого отпуска в год. Отпуск должен быть согласован с руководителем не менее чем за 2 недели. Неиспользованные дни отпуска могут быть перенесены на следующий год в размере не более 14 дней.",
        "metadata": {"topic": "отпуска", "department": "HR"},
    },
    {
        "id": "doc_2",
        "text": "Персональные дни: Сотрудник имеет право на 1-2 персональных дня в год (день рождения, годовщина работы в компании). Персональный день должен быть использован в течение месяца от даты события. Согласование через HR-портал.",
        "metadata": {"topic": "персональные_дни", "department": "HR"},
    },
    {
        "id": "doc_3",
        "text": "Больничные листы: При заболевании сотрудник обязан уведомить руководителя в первый день нетрудоспособности. Больничный лист необходимо предоставить в отдел кадров в течение 3 рабочих дней после выхода на работу. Оплата по больничному производится согласно ТК РФ.",
        "metadata": {"topic": "больничные", "department": "HR"},
    },
    {
        "id": "doc_4",
        "text": "Удалённая работа: Гибридный формат предусматривает 2 дня в офисе и 3 дня удалённо. Полностью удалённая работа возможна по согласованию с руководством. Необходимо быть доступным в рабочие часы 10:00-18:00 по московскому времени.",
        "metadata": {"topic": "удалённая_работа", "department": "HR"},
    },
    {
        "id": "doc_5",
        "text": "Оформление приёма на работу: При приёме необходимы паспорт, ИНН, СНИЛС, трудовая книжка или договор на ведение электронной. Медицинская книжка для отдельных должностей. Испытательный срок до 3 месяцев по согласованию.",
        "metadata": {"topic": "приём_на_работу", "department": "HR"},
    },
    {
        "id": "doc_6",
        "text": "Командировки: Командировочные расходы возмещаются по чекам. Суточные 700 рублей в России, 2500 рублей за рубежом. Предварительное согласование командировки через систему учёта. Билеты и отели бронируются через корпоративного поставщика.",
        "metadata": {"topic": "командировки", "department": "HR"},
    },
    {
        "id": "doc_7",
        "text": "ДМС и льготы: Добровольное медицинское страхование для всех сотрудников после испытательного срока. Дополнительно: компенсация занятий спортом до 5000 руб/мес, обучение до 100000 руб/год. Оплата мобильной связи для удалённых сотрудников.",
        "metadata": {"topic": "льготы", "department": "HR"},
    },
]

# Ключевые слова для семантического поиска (запрос -> темы документов)
QUERY_KEYWORDS = {
    "отпуск": ["отпуска", "отпуск", "каникул"],
    "vacation": ["отпуска"],
    "персональн": ["персональные_дни", "персональн"],
    "день рожден": ["персональные_дни"],
    "больничн": ["больничные", "больничн", "заболеван"],
    "sick": ["больничные"],
    "удалённ": ["удалённая_работа", "удалённ", "офис", "гибрид"],
    "remote": ["удалённая_работа"],
    "приём": ["приём_на_работу", "приём", "оформлен"],
    "документы": ["приём_на_работу"],
    "командиров": ["командировки", "командиров", "суточн"],
    "льгот": ["льготы", "льгот", "ДМС", "страхован"],
    "спорт": ["льготы"],
}


def _tokenize(text: str) -> set[str]:
    """Разбить текст на токены (слова в нижнем регистре)."""
    text_lower = text.lower()
    words = re.findall(r"[а-яёa-z0-9]+", text_lower)
    return set(words)


def _score_document(query: str, doc: dict) -> float:
    """Оценить релевантность документа запросу (0-1)."""
    query_tokens = _tokenize(query)
    doc_tokens = _tokenize(doc["text"])
    doc_meta = " ".join(str(v) for v in doc["metadata"].values()).lower()

    # Совпадение ключевых слов
    keyword_score = 0.0
    for q_part, topics in QUERY_KEYWORDS.items():
        if q_part in query.lower():
            for topic in topics:
                if topic in doc["text"].lower() or topic in doc_meta:
                    keyword_score = max(keyword_score, 0.9)
                    break

    # TF-style: сколько слов запроса есть в документе
    if query_tokens:
        overlap = len(query_tokens & doc_tokens) / len(query_tokens)
        token_score = overlap * 0.7
    else:
        token_score = 0.0

    return min(1.0, keyword_score + token_score + 0.1)  # базовая релевантность 0.1


def rag_search(query: str, n_results: int = 5) -> list[dict]:
    """
    Поиск по HR-документам с помощью RAG (семантический + ключевые слова).

    Args:
        query: Поисковый запрос
        n_results: Количество возвращаемых документов (по умолчанию 5)

    Returns:
        Список найденных документов: [{"text", "relevance", "topic"}, ...]
    """
    scored = [(doc, _score_document(query, doc)) for doc in HR_DOCUMENTS]
    scored.sort(key=lambda x: x[1], reverse=True)

    # Берём только документы с релевантностью > 0.1
    filtered = [(doc, score) for doc, score in scored if score > 0.1][:n_results]

    if not filtered:
        # Если ничего не найдено — возвращаем все документы как справочную информацию
        filtered = scored[:n_results]

    return [
        {
            "text": doc["text"],
            "relevance": score,
            "topic": doc["metadata"].get("topic", "N/A"),
        }
        for doc, score in filtered
    ]
